name: Deploy Frontend

on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4

      - name: Sincronizar archivos con rsync
        uses: burnett01/rsync-deployments@6.1
        with:
          node_modules_mode: "delete"
          ssh_key: ${{ secrets.KEY }}
          source: ./
          target: /home/ubuntu/code_room_frontend
          remote_host: ${{ secrets.IP_SERVER }}
          remote_user: ${{ secrets.USERNAME }}
          rsync_path: /usr/bin/rsync # Para asegurar compatibilidad

      - name: Configurar variables de entorno del sistema
        uses: appleboy/ssh-action@v1
        with:
          host: ${{secrets.IP_SERVER}}
          username: ${{secrets.USERNAME}}
          key: ${{secrets.KEY}}
          port: ${{secrets.PORT}}
          script: |
              echo "Configurando variables de entorno..."
              
              # üöÄ CAMBIO 1: Asegurarse de que el directorio exista y dar permisos
              sudo mkdir -p /etc/environment.d
              sudo chown $USER /etc/environment.d
              
              # Crear el archivo de configuraci√≥n
              sudo tee /etc/environment.d/code_room_frontend.conf > /dev/null <<EOF
              # Code Room Frontend Environment Variables
              export NEXT_PUBLIC_SUPABASE_URL="${{secrets.NEXT_PUBLIC_SUPABASE_URL}}"
              export NEXT_PUBLIC_SUPABASE_ANON_KEY="${{secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY}}"
              export JWT_SECRET="${{secrets.JWT_SECRET}}"
              export DATABASE_URL="${{secrets.DATABASE_URL}}"
              export NEXT_PUBLIC_GOOGLE_MAPS_API_KEY="${{secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY}}"
              export NEXT_PUBLIC_PUSHER_APP_KEY="${{secrets.NEXT_PUBLIC_PUSHER_APP_KEY}}"
              export NEXT_PUBLIC_PUSHER_APP_CLUSTER="${{secrets.NEXT_PUBLIC_PUSHER_APP_CLUSTER}}"
              export PUSHER_APP_ID="${{secrets.PUSHER_APP_ID}}"
              export PUSHER_APP_SECRET="${{secrets.PUSHER_APP_SECRET}}"
              EOF
              
              # Cargar variables en la sesi√≥n actual
              source /etc/environment.d/code_room_frontend.conf 2>/dev/null || true
              
              echo "‚úÖ Variables de entorno configuradas correctamente"

      - name: Limpiar contenedores y construir imagen
        uses: appleboy/ssh-action@v1
        with:
          host: ${{secrets.IP_SERVER}}
          username: ${{secrets.USERNAME}}
          key: ${{secrets.KEY}}
          port: ${{secrets.PORT}}
          # üõë Eliminamos command_timeout para confiar en el caching de Docker.
          script: |
              cd /home/ubuntu/code_room_frontend
              
              # Cargar variables de entorno del sistema
              source /etc/environment.d/code_room_frontend.conf 2>/dev/null || true
              
              # Detener contenedores antiguos
              docker compose down || true
              
              # Limpiar espacio en disco (im√°genes y cach√© sin usar)
              echo "Limpiando im√°genes antiguas..."
              docker system prune -af --volumes
              
              # Construir imagen: A√±adimos el argumento de build para npm ci
              echo "Construyendo imagen Next.js (con cache y --legacy-peer-deps)..."
              # üöÄ CAMBIO 2: Pasar el argumento al Dockerfile
              docker compose build --build-arg NPM_CI_FLAGS="--legacy-peer-deps"
              
              echo "Levantando contenedor..."
              docker compose up -d
              
              # Esperar 15 segundos para que inicie
              sleep 15
              
              # Verificar estado
              echo "Estado del contenedor:"
              docker compose ps
              
              echo "√öltimas l√≠neas del log:"
              docker compose logs --tail=50